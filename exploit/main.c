/*--------------------------
  $ gcc --version
  gcc (GCC) 8.2.1 20181127
--------------------------*/

#include <stdio.h>
#include <string.h>

int main()
{
  char buf[4]; // char + char + char + \0
  char data[] = "Buffer Over Flow!";
  // exploit
  /* char *gets(char *dest); */
  // alternative
  /* char *fgets(char *dest, int n, FILE *stream); */
  //gets(gets_buf); // BOF
  printf("fgets(): ");
  fgets(buf, sizeof buf, stdin);
  printf("fgets: %s\n", buf); // この場合, 入力文字の先頭3文字が表示される


  // exploit
  /* char *strcpy(char *dest, const char *src); */
  // alternative
  /* char *strncpy(char *dest, const char *src, size_t n); */
  memset(buf, 0, sizeof buf);
  //strcpy(strcpy_buf, data);  // BOFしない... 全文表示された
  strncpy(buf, data, sizeof(buf)-1); // 最後はnull文字
  printf("strncpy: %s\n", buf);


  // exploit
  /* char *strcat(char *dest, const char *src); */
  // alternative
  /* char *strncat(char *dest, const char *src, size_t n); */
  memset(buf, 0, sizeof buf);
  //strcat(buf, data);  // BOFしない... 全文表示された
  strncpy(buf, data, sizeof(buf)-strlen(buf)-1); // 最後はnull文字
  printf("strncat: %s\n", buf);


  // exploit
  /* int sprintf(char *dest, const char *format, ...); */
  // alternative
  /* int snprintf(char *dest, size_t n, const char *format, ...); */
  //sprintf(buf, "%s", data); //BOFしない... 全文表示された
  snprintf(buf, sizeof buf, "%s", data);
  //sprintf(buf, "%.3s", data); // "%.文字数s"で精度を指定しても良い
  printf("sprintf: %s\n", buf);


  // exploit
  /* int scanf(const char *format, ...); */ // 空白,タブ,改行まで読み込む
  //memset(buf, 0, sizeof buf);
  //fflush(stdin);
  //fflush(stdout);
  printf("scanf(): ");
  scanf("%.3s", buf); // 精度を指定する
  printf("scanf: %s\n", buf);
}
